@page "/export"

@inject IHttpClientFactory httpClientFactory;
@inject DateHandler dateHandler;
@inject FontServices fontServices;
@inject IASBNDataService dataService;
@inject IFileSystemAccessService FileSystemAccessService;
@inject ISnackbar Snackbar;

@using ASBNApp.Frontend.Helpers
@using PdfSharp.Fonts;
@using KristofferStrube.Blazor.FileSystem;


<PageTitle>Export</PageTitle>

<MudContainer Class="mt-5" MaxWidth="MaxWidth.ExtraExtraLarge">
	@* Check if the browser supports exporting a file *@
	@if(!_isSupported)
	{
		<UnsupportedBrowserHelp />
	}
	else
	{
		@* Header space *@
		<MudItem Elevation="0" Class="my-10">
			<MudText Typo="Typo.h3" Class="mb-5">Let's get this exported!</MudText>
			<MudText Typo="Typo.subtitle1">Attention: You still need to manually sign these (if required by your company).</MudText>
		</MudItem>

		<MudPaper Outlined="true" Class="mt-5 pa-5">
			<MudGrid>

				<MudItem xs="12">
					<MudText Typo="Typo.body2">Select a week to export data for:</MudText>
					@* Add pill selector for weeks here *@
					<PillSelectorWeek @bind-SelectedWeek="SelectedWeek" @bind-SelectedYear="SelectedYear" SelectedDateChanged="GetData"/>
				</MudItem>

				<MudItem xs="12">
					@if(_tooManyEntries)
					{
						<MudAlert Severity="Severity.Error">
							<b>Cannot export a week with more than 5 entries.</b> 
							Please delete entries from the week view before exporting.
						</MudAlert>
					}
					else
					{
						<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ExportData">Export Data</MudButton>
					}
				</MudItem>
			</MudGrid>
		</MudPaper>
	}
	
</MudContainer>


@code {
	private bool _isSupported;
	private bool _tooManyEntries;
	List<EntryRowModelWithID>? rows;

	// Variables to bind to the child week picker
	public int? SelectedWeek { get; set; }
	public int? SelectedYear { get; set; }

	protected override void OnInitialized()
	{
		GetData();
	}


	// As soon as we finished loading the page, get the required fonts
	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			// Check if the browser supports the FileSystemAccess API
			_isSupported = await FileSystemAccessService.IsSupportedAsync();
			StateHasChanged();

			// Implement a custom font resolver (we do seem to need one, yes ^^)
			Fonts font = await fontServices.LoadFonts();
			try
			{
				GlobalFontSettings.FontResolver = new CustomFontResolver(font);
			}
			catch (Exception e)
			{
				Console.WriteLine(e.Message);
			}
		}
	}

	/// <summary>
	/// 
	/// </summary>
	/// <returns></returns>
	private async Task GetData()
	{
		var startDate = dateHandler.GetFirstDateOfWeek((int)SelectedWeek, (int)SelectedYear);
		var endDate = dateHandler.GetLastDateOfWeek((int)SelectedWeek, (int)SelectedYear);
		rows = MainViewWeekHelper.GetCompleteWeek(await dataService.GetWeek(startDate, endDate), SelectedWeek, SelectedYear);

		_tooManyEntries = (rows.Count > 5) ? true : false;
	}


	// Export PDF for the variables SelectedWeek & SeletedYear
	private async void ExportData()
	{
		// Get Data we want to generate the pdf from
		//Settings settings = dataService.GetSettings();

		// TODO: To be removed, only for debugging purposes!
		Model.Settings settings = new()
		{
			Username = "Max Mustermann",
		};

		// Handles exporting the PDF
		PDFExportHandler pdfHandler = new PDFExportHandler(dateHandler);

		// Open the pdf template file in a bytestream
		var _httpClient = httpClientFactory.CreateClient("FrontendClient");
		byte[] fileBytes = await _httpClient.GetByteArrayAsync("pdf/Vorlage_ASBN.pdf");

		try
		{
			// Get fileHandle for the output PDF
			var options = new SaveFilePickerOptionsStartInFileSystemHandle()
				{
					SuggestedName = $"Export-Week{SelectedWeek}-{SelectedYear}",
					Types = Data.FilePickerAcceptTypes.fileTypePDF
				};

			FileSystemFileHandle? fileHandle = await FileSystemAccessService.ShowSaveFilePickerAsync(options);
			using (var outputStream = await fileHandle.CreateWritableAsync())
			{
				// Hand data over to the PDF handling class
				await pdfHandler.GeneratePDF(fileBytes, outputStream, rows, settings, SelectedWeek, SelectedYear);

				// Close the stream and write file to disk
				await outputStream.CloseAsync();
				Snackbar.Add("Your PFD just finished exporting!", Severity.Success);
			}
		}
		catch (Exception e)
		{
			Snackbar.Add($"Failed to create your PDF file. Error: {e.Message}", Severity.Error);
		}
	}
}