@inherits LayoutComponentBase

@inject NavigationManager navigationManager;
@inject AuthenticationStateProvider authenticationStateProvider

<MudThemeProvider @ref="@_mudThemeProvider" @bind-IsDarkMode="@_isDarkMode" Theme="_theme" />
<MudPopoverProvider />
<MudDialogProvider/>
<MudSnackbarProvider/>

<PageTitle>ASBNApp</PageTitle>


<MudLayout>
    <NavBar @bind-IsDarkMode="_isDarkMode"/>
    <MudMainContent>
        <CascadingAuthenticationState>
            @if (!_isLoading)
            {
                @Body
            }
            else
            {
                <CheckingAuthentication />
            }
        </CascadingAuthenticationState>
    </MudMainContent>
</MudLayout>



@code{
    private bool _isLoading = true;

    // Theme related stuff
    private bool _isDarkMode;
	private MudTheme _theme = DefaultTheme.GetTheme();
	private MudThemeProvider _mudThemeProvider;

    /// <summary>
    /// Redirect the user to the login page if he's not logged in.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationStateProvider.GetAuthenticationStateAsync();

        if (authState.User.Identity.IsAuthenticated)
        {
            // Redirect if user is on index page, but authenticated
            if (navigationManager.Uri.EndsWith("/"))
            {
                navigationManager.NavigateTo("/app");
            }
        }
        else
        {
            // Redirect if user is on a protected page, but not authenticated
            if (navigationManager.Uri.EndsWith("/login") || navigationManager.Uri.EndsWith("/register") || navigationManager.Uri.EndsWith("/")) { } 
            else
            {
                navigationManager.NavigateTo("/");
            }
        }

        _isLoading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await _mudThemeProvider.WatchSystemPreference(OnSystemPreferenceChanged);
            StateHasChanged();
        }
    }

    private Task OnSystemPreferenceChanged(bool newValue)
    {
        _isDarkMode = newValue;
        StateHasChanged();
        return Task.CompletedTask;
    }
}